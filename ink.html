<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>百草珍酿学习课 V3.0</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      touch-action: manipulation;
    }
    
    /* 加载动画 */
    .loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      width: 100px;
      height: 100px;
    }
    
    .dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }
    
    .dot-1 {
      background-color: #ffe386;
      animation: dot-1-move 2s ease infinite;
    }
    
    .dot-2 {
      background-color: #10beae;
      animation: dot-2-move 2s ease infinite;
    }
    
    .dot-3 {
      background-color: #f74d75;
      animation: dot-3-move 2s ease infinite;
    }
    
    @keyframes dot-1-move {
      20% { transform: scale(1); }
      45% { transform: translate(16px, 12px) scale(0.45); }
      60% { transform: translate(20px, 15px) scale(0.45); }
      80% { transform: translate(20px, 15px) scale(0.45); }
      100% { transform: translateY(0px) scale(1); }
    }
    
    @keyframes dot-2-move {
      20% { transform: scale(1); }
      45% { transform: translate(-16px, 12px) scale(0.45); }
      60% { transform: translate(-20px, 15px) scale(0.45); }
      80% { transform: translate(-20px, 15px) scale(0.45); }
      100% { transform: translateY(0px) scale(1); }
    }
    
    @keyframes dot-3-move {
      20% { transform: scale(1); }
      45% { transform: translateY(-18px) scale(0.45); }
      60% { transform: translateY(-25px) scale(0.45); }
      80% { transform: translateY(-25px) scale(0.45); }
      100% { transform: translateY(0px) scale(1); }
    }
    
    .loader {
      animation: rotate-move 2s ease-in-out infinite;
    }
    
    @keyframes rotate-move {
      55% { transform: translate(-50%, -50%) rotate(0deg); }
      80% { transform: translate(-50%, -50%) rotate(360deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* 缓冲提示 */
    .buffering-tip {
      position: fixed;
      top: 25%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
      z-index: 95;
      padding: 20px;
      width: 100%;
      display: none;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 15px;
      max-width: 80%;
    }
    
    .buffering-title {
      font-size: 28px;
      margin-bottom: 15px;
      color: #ffe386;
    }
    
    .buffering-subtitle {
      font-size: 24px;
      margin-bottom: 20px;
      color: #10beae;
    }
    
    .countdown {
      font-size: 40px;
      color: #ffffff;
      margin-top: 10px;
    }
    
    /* 播放提示 */
    .play-tip {
      position: fixed;
      top: 25%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.9);
      z-index: 95;
      animation: fadeInOut 2s infinite;
      padding: 0 20px;
      width: 100%;
      display: none;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    
    /* 新增提示文字 */
    .additional-tip {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: white;
      font-size: 16px;
      z-index: 95;
      padding: 0 20px;
      width: 100%;
      max-width: 90%;
      display: none;
      line-height: 1.5;
    }
    
    /* 自定义视频播放器 */
    .custom-player {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 90;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .custom-player video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* 播放按钮 */
    .play-button {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, 0);
      z-index: 99;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 36px;
      cursor: pointer;
      display: none;
      justify-content: center;
      align-items: center;
      transition: all 0.3s;
    }
    
    .play-button:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: translate(-50%, 0) scale(1.05);
    }
    
    /* 暂停按钮 */
    .pause-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 98;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 36px;
      cursor: pointer;
      display: none;
      justify-content: center;
      align-items: center;
      transition: all 0.3s;
    }
    
    /* 全屏按钮 */
    .fullscreen-button {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 99;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: none;
    }
    
    .fullscreen-button:hover {
      background: rgba(0, 0, 0, 0.9);
    }
    
    /* 错误提示 */
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 200;
      display: none;
    }
    
    /* 视频封面 */
    .video-cover {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 85;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .video-cover img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0.7;
    }
    
    /* 点击区域 */
    .click-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 97;
      cursor: pointer;
      display: none;
    }
    
    /* 进度条容器 */
    .progress-container {
      position: fixed;
      bottom: 70px;
      left: 20px;
      right: 20px;
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      z-index: 98;
      display: none;
      transition: opacity 0.3s;
    }
    
    /* 进度条 */
    .progress-bar {
      height: 100%;
      background: #f74d75;
      border-radius: 5px;
      width: 0%;
      transition: width 0.2s;
      pointer-events: none;
    }
    
    /* 时间显示 */
    .time-display {
      position: fixed;
      bottom: 50px;
      left: 20px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      z-index: 98;
      display: none;
      transition: opacity 0.3s;
    }
    
    /* 链接检测提示 */
    .link-checking {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      z-index: 95;
      display: none;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
    }
    
    /* 重试按钮 */
    .retry-button {
      position: fixed;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 201;
      background: #f74d75;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      display: none;
    }
    
    /* 备用播放器容器 */
    .fallback-player {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 90;
      display: none;
    }
    
    .fallback-player iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <!-- 链接检测提示 -->
  <div class="link-checking" id="linkChecking">
    <div style="font-size: 24px; margin-bottom: 15px;">正在解析视频地址...</div>
    <div style="font-size: 16px;">请稍候，正在获取真实视频链接</div>
  </div>
  
  <!-- 加载动画 -->
  <div class="loader">
    <div class="dot dot-1"></div>
    <div class="dot dot-2"></div>
    <div class="dot dot-3"></div>
  </div>
  
  <!-- 缓冲提示 -->
  <div class="buffering-tip" id="bufferingTip">
    <div class="buffering-title">百草珍酿 节目缓冲中</div>
    <div class="buffering-subtitle">请稍候...</div>
    <div class="countdown" id="countdown">3秒</div>
  </div>
  
  <!-- 播放提示 -->
  <div class="play-tip" id="playTip">请您点击下面的播放键进行观看</div>
  
  <!-- 新增提示文字 -->
  <div class="additional-tip" id="additionalTip">注：观看人较多，如遇到播放不顺畅，请您暂停几秒，再重新点击播放</div>
  
  <!-- 自定义视频播放器 -->
  <div class="custom-player" id="customPlayer">
    <video id="videoElement" playsinline webkit-playsinline preload="auto"></video>
  </div>
  
  <!-- 备用播放器 -->
  <div class="fallback-player" id="fallbackPlayer"></div>
  
  <!-- 视频封面 -->
  <div class="video-cover" id="videoCover">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 450' fill='%23333'%3E%3Cpath d='M400,225 L500,175 L500,275 Z' fill='%23666'/%3E%3C/svg%3E" alt="视频封面">
  </div>
  
  <!-- 点击区域 -->
  <div class="click-area" id="clickArea"></div>
  
  <!-- 进度条 -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  
  <!-- 时间显示 -->
  <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
  
  <!-- 播放按钮 -->
  <button class="play-button" id="playButton">▶</button>
  
  <!-- 暂停按钮 -->
  <button class="pause-button" id="pauseButton">❚❚</button>
  
  <!-- 全屏按钮 -->
  <button class="fullscreen-button" id="fullscreenButton">全屏播放</button>
  
  <!-- 错误提示 -->
  <div class="error-message" id="errorMessage"></div>
  
  <!-- 重试按钮 -->
  <button class="retry-button" id="retryButton">重试播放</button>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 获取DOM元素
      const loader = document.querySelector('.loader');
      const linkChecking = document.getElementById('linkChecking');
      const bufferingTip = document.getElementById('bufferingTip');
      const countdown = document.getElementById('countdown');
      const playTip = document.getElementById('playTip');
      const additionalTip = document.getElementById('additionalTip');
      const customPlayer = document.getElementById('customPlayer');
      const videoElement = document.getElementById('videoElement');
      const fallbackPlayer = document.getElementById('fallbackPlayer');
      const videoCover = document.getElementById('videoCover');
      const clickArea = document.getElementById('clickArea');
      const playButton = document.getElementById('playButton');
      const pauseButton = document.getElementById('pauseButton');
      const fullscreenButton = document.getElementById('fullscreenButton');
      const errorMessage = document.getElementById('errorMessage');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const timeDisplay = document.getElementById('timeDisplay');
      const retryButton = document.getElementById('retryButton');
      
      // 播放状态控制
      let isPlaying = false;
      let progressTimer = null;
      let hideControlsTimer = null;
      let countdownTimer = null;
      let countdownValue = 3;
      let isVideoLoaded = false;
      let currentVideoUrl = '';
      let errorCount = 0;
      const MAX_RETRIES = 2; // 最大重试次数
      
      // 获取URL参数
      const urlParams = new URLSearchParams(window.location.search);
      const encodedParam = urlParams.get('c');
      
      if (!encodedParam) {
        showError('无效的视频参数');
        return;
      }
      
      // 解码URL
      let videoUrl;
      try {
        videoUrl = atob(encodedParam);
      } catch (e) {
        showError('视频参数格式错误');
        return;
      }
      
      if (!videoUrl.includes("http")) {
        showError('无效的视频链接');
        return;
      }
      
      // 开始检测链接
      startLinkDetection(videoUrl);
      
      // 重试按钮事件
      retryButton.addEventListener('click', function() {
        retryButton.style.display = 'none';
        errorMessage.style.display = 'none';
        startLinkDetection(videoUrl);
      });
      
      // 链接检测函数 - 优先使用自定义播放器
      function startLinkDetection(url) {
        // 重置状态
        errorCount = 0;
        isVideoLoaded = false;
        fallbackPlayer.style.display = 'none';
        customPlayer.style.display = 'flex';
        
        linkChecking.style.display = 'block';
        loader.style.display = 'none';
        
        console.log('开始检测链接:', url);
        
        // 获取最终视频地址
        getFinalVideoUrl(url)
          .then(finalUrl => {
            console.log('获取到最终视频地址:', finalUrl);
            currentVideoUrl = finalUrl;
            linkChecking.style.display = 'none';
            loader.style.display = 'block';
            bufferingTip.style.display = 'block';
            
            // 检测视频类型并设置合适的MIME类型
            setupVideoSource(finalUrl);
            
            // 开始缓冲视频
            videoElement.load();
            
            // 开始倒计时
            startCountdown();
          })
          .catch(error => {
            console.log('获取视频地址失败:', error);
            // 直接使用原始URL尝试播放
            currentVideoUrl = url;
            linkChecking.style.display = 'none';
            loader.style.display = 'block';
            bufferingTip.style.display = 'block';
            
            setupVideoSource(url);
            videoElement.load();
            startCountdown();
          });
      }
      
      // 设置视频源，根据URL推测MIME类型
      function setupVideoSource(url) {
        // 清除现有源
        while (videoElement.firstChild) {
          videoElement.removeChild(videoElement.firstChild);
        }
        
        // 尝试检测视频类型
        let type = '';
        if (url.includes('.mp4') || url.includes('mp4')) {
          type = 'video/mp4';
        } else if (url.includes('.webm')) {
          type = 'video/webm';
        } else if (url.includes('.mov')) {
          type = 'video/quicktime';
        } else if (url.includes('.m3u8')) {
          type = 'application/x-mpegURL';
        }
        
        // 创建source元素
        const source = document.createElement('source');
        source.src = url;
        if (type) {
          source.type = type;
          console.log('设置视频类型:', type);
        }
        
        videoElement.appendChild(source);
        videoElement.src = url; // 直接设置src作为备选
      }
      
      // 获取最终视频URL
      function getFinalVideoUrl(url) {
        return new Promise((resolve, reject) => {
          // 先尝试HEAD请求获取最终URL
          fetch(url, { method: 'HEAD', redirect: 'follow' })
            .then(response => {
              if (response.url) {
                resolve(response.url);
              } else {
                resolve(url);
              }
            })
            .catch(error => {
              console.log('HEAD请求失败，尝试iframe方法:', error);
              // HEAD请求失败，尝试iframe方法
              getRedirectUrlWithIframe(url)
                .then(resolve)
                .catch(() => {
                  // 所有方法都失败，返回原始URL
                  resolve(url);
                });
            });
        });
      }
      
      // 使用iframe获取重定向地址
      function getRedirectUrlWithIframe(url) {
        return new Promise((resolve, reject) => {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = url;
          
          // 设置超时
          const timeout = setTimeout(() => {
            document.body.removeChild(iframe);
            reject(new Error('获取重定向地址超时'));
          }, 10000);
          
          iframe.onload = function() {
            clearTimeout(timeout);
            try {
              const iframeUrl = iframe.contentWindow.location.href;
              document.body.removeChild(iframe);
              
              if (iframeUrl !== url) {
                console.log('检测到重定向:', iframeUrl);
                resolve(iframeUrl);
              } else {
                resolve(url);
              }
            } catch (e) {
              console.log('跨域限制，无法获取iframe的URL:', e);
              document.body.removeChild(iframe);
              resolve(url);
            }
          };
          
          iframe.onerror = function() {
            clearTimeout(timeout);
            document.body.removeChild(iframe);
            reject(new Error('iframe加载错误'));
          };
          
          document.body.appendChild(iframe);
        });
      }
      
      // 监听视频加载进度
      videoElement.addEventListener('progress', function() {
        if (videoElement.buffered.length > 0 && videoElement.buffered.end(0) > 5) {
          isVideoLoaded = true;
        }
      });
      
      // 监听视频可以播放事件
      videoElement.addEventListener('canplay', function() {
        isVideoLoaded = true;
        console.log('视频已加载，可以播放');
      });
      
      // 倒计时函数
      function startCountdown() {
        countdown.textContent = countdownValue + '秒';
        
        countdownTimer = setInterval(() => {
          countdownValue--;
          
          if (countdownValue > 0) {
            countdown.textContent = countdownValue + '秒';
          } else {
            clearInterval(countdownTimer);
            finishBuffering();
          }
        }, 1000);
      }
      
      // 完成缓冲
      function finishBuffering() {
        loader.style.display = 'none';
        bufferingTip.style.display = 'none';
        playTip.style.display = 'block';
        additionalTip.style.display = 'block';
        playButton.style.display = 'flex';
        fullscreenButton.style.display = 'block';
        clickArea.style.display = 'block';
        
        if (isVideoLoaded) {
          console.log('视频已预加载完成，点击即可播放');
        } else {
          console.log('视频仍在加载中...');
        }
      }
      
      // 播放按钮事件
      playButton.addEventListener('click', function() {
        playVideo();
      });
      
      // 暂停按钮事件
      pauseButton.addEventListener('click', function() {
        playVideo();
      });
      
      // 点击区域事件 - 点击屏幕暂停/播放
      clickArea.addEventListener('click', function() {
        if (isPlaying) {
          pauseVideo();
        } else {
          playVideo();
        }
      });
      
      // 全屏按钮事件
      fullscreenButton.addEventListener('click', toggleFullscreen);
      
      // 视频事件监听
      videoElement.addEventListener('play', function() {
        isPlaying = true;
        playButton.style.display = 'none';
        playTip.style.display = 'none';
        additionalTip.style.display = 'none';
        videoCover.style.display = 'none';
        pauseButton.style.display = 'none';
        
        // 隐藏进度条和时间显示
        progressContainer.style.display = 'none';
        timeDisplay.style.display = 'none';
        
        // 开始更新进度
        startProgressUpdate();
      });
      
      videoElement.addEventListener('pause', function() {
        isPlaying = false;
        pauseButton.style.display = 'flex';
        
        // 显示进度条和时间显示
        progressContainer.style.display = 'block';
        timeDisplay.style.display = 'block';
        
        // 停止更新进度
        stopProgressUpdate();
        
        // 3秒后自动隐藏暂停按钮
        clearTimeout(hideControlsTimer);
        hideControlsTimer = setTimeout(() => {
          if (!isPlaying) {
            pauseButton.style.display = 'none';
          }
        }, 3000);
      });
      
      videoElement.addEventListener('ended', function() {
        isPlaying = false;
        playButton.style.display = 'flex';
        playButton.innerHTML = '▶';
        videoCover.style.display = 'flex';
        pauseButton.style.display = 'none';
        
        // 隐藏进度条和时间显示
        progressContainer.style.display = 'none';
        timeDisplay.style.display = 'none';
        
        // 停止更新进度
        stopProgressUpdate();
      });
      
      videoElement.addEventListener('timeupdate', function() {
        updateProgress();
      });
      
      // 增强的错误处理
      videoElement.addEventListener('error', function() {
        console.log('视频元素错误，代码:', videoElement.error.code);
        errorCount++;
        
        // 先尝试重试几次
        if (errorCount <= MAX_RETRIES) {
          console.log(`尝试重新加载视频 (${errorCount}/${MAX_RETRIES})`);
          showError(`视频加载失败，正在重试 (${errorCount}/${MAX_RETRIES})`);
          
          // 重新加载视频
          setTimeout(() => {
            errorMessage.style.display = 'none';
            retryButton.style.display = 'none';
            loader.style.display = 'block';
            videoElement.src = currentVideoUrl;
            videoElement.load();
          }, 1500);
        } else {
          // 多次重试失败后才使用iframe作为最后的备选
          console.log('多次尝试失败，尝试iframe方式作为最后的备选');
          tryIframePlayback(currentVideoUrl);
        }
      });
      
      // 监听视频卡顿/缓冲
      videoElement.addEventListener('waiting', function() {
        console.log('视频缓冲中...');
        loader.style.display = 'block';
      });
      
      videoElement.addEventListener('playing', function() {
        console.log('视频继续播放');
        loader.style.display = 'none';
      });
      
      // 双击切换全屏
      videoElement.addEventListener('dblclick', toggleFullscreen);
      
      // 禁用右键菜单
      videoElement.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
      });
      
      // 播放视频函数
      function playVideo() {
        if (videoElement.paused) {
          videoElement.play()
            .then(() => {
              isPlaying = true;
              playButton.style.display = 'none';
              playTip.style.display = 'none';
              additionalTip.style.display = 'none';
              videoCover.style.display = 'none';
              pauseButton.style.display = 'none';
              
              // 隐藏进度条和时间显示
              progressContainer.style.display = 'none';
              timeDisplay.style.display = 'none';
              
              // 开始更新进度
              startProgressUpdate();
            })
            .catch(error => {
              console.log('播放失败:', error);
              errorCount++;
              
              if (errorCount <= MAX_RETRIES) {
                console.log(`尝试重新播放 (${errorCount}/${MAX_RETRIES})`);
                setTimeout(() => playVideo(), 1000);
              } else {
                tryIframePlayback(currentVideoUrl);
              }
            });
        } else {
          pauseVideo();
        }
      }
      
      // 暂停视频函数
      function pauseVideo() {
        videoElement.pause();
        isPlaying = false;
        pauseButton.style.display = 'flex';
        
        // 显示进度条和时间显示
        progressContainer.style.display = 'block';
        timeDisplay.style.display = 'block';
        
        // 停止更新进度
        stopProgressUpdate();
        
        // 3秒后自动隐藏暂停按钮
        clearTimeout(hideControlsTimer);
        hideControlsTimer = setTimeout(() => {
          if (!isPlaying) {
            pauseButton.style.display = 'none';
          }
        }, 3000);
      }
      
      // 开始更新进度
      function startProgressUpdate() {
        progressTimer = setInterval(updateProgress, 200);
      }
      
      // 停止更新进度
      function stopProgressUpdate() {
        if (progressTimer) {
          clearInterval(progressTimer);
          progressTimer = null;
        }
      }
      
      // 更新进度条
      function updateProgress() {
        if (videoElement.duration) {
          const percent = (videoElement.currentTime / videoElement.duration) * 100;
          progressBar.style.width = percent + '%';
          
          // 更新时间显示
          updateTimeDisplay();
        }
      }
      
      // 更新时间显示
      function updateTimeDisplay() {
        const currentTime = formatTime(videoElement.currentTime);
        const duration = formatTime(videoElement.duration);
        timeDisplay.textContent = `${currentTime} / ${duration}`;
      }
      
      // 格式化时间
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      
      // 监听全屏变化
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
      document.addEventListener('mozfullscreenchange', updateFullscreenButton);
      document.addEventListener('MSFullscreenChange', updateFullscreenButton);
      
      // 全屏功能
      function toggleFullscreen() {
        if (!document.fullscreenElement && !document.webkitFullscreenElement && 
            !document.mozFullScreenElement && !document.msFullscreenElement) {
          // 进入全屏
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(err => {
              console.error('全屏错误:', err);
            });
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) {
            document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
          }
        } else {
          // 退出全屏
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }
      
      // 更新全屏按钮文本
      function updateFullscreenButton() {
        if (document.fullscreenElement || document.webkitFullscreenElement || 
            document.mozFullScreenElement || document.msFullscreenElement) {
          fullscreenButton.textContent = '竖屏播放';
        } else {
          fullscreenButton.textContent = '全屏播放';
        }
      }
      
      // 错误处理
      function showError(message) {
        loader.style.display = 'none';
        bufferingTip.style.display = 'none';
        linkChecking.style.display = 'none';
        if (countdownTimer) clearInterval(countdownTimer);
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        retryButton.style.display = 'block';
        console.error(message);
      }
      
      // 尝试使用iframe播放（仅作为最后的备选方案）
      function tryIframePlayback(url) {
        console.log('已尝试所有方法，最后尝试iframe播放:', url);
        
        // 显示切换播放器提示
        errorMessage.textContent = '检测到视频格式兼容性问题，正在切换到备用播放器...';
        errorMessage.style.display = 'block';
        retryButton.style.display = 'none';
        
        setTimeout(() => {
          // 隐藏自定义播放器，显示iframe播放器
          customPlayer.style.display = 'none';
          playButton.style.display = 'none';
          pauseButton.style.display = 'none';
          progressContainer.style.display = 'none';
          timeDisplay.style.display = 'none';
          videoCover.style.display = 'none';
          errorMessage.style.display = 'none';
          
          // 创建iframe
          fallbackPlayer.innerHTML = '';
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.setAttribute('allowfullscreen', '');
          iframe.setAttribute('webkitallowfullscreen', '');
          iframe.setAttribute('mozallowfullscreen', '');
          iframe.setAttribute('allow', 'autoplay; fullscreen');
          
          fallbackPlayer.appendChild(iframe);
          fallbackPlayer.style.display = 'block';
          
          // 更新全屏按钮功能
          fullscreenButton.onclick = function() {
            if (iframe.requestFullscreen) {
              iframe.requestFullscreen();
            } else if (iframe.webkitRequestFullscreen) {
              iframe.webkitRequestFullscreen();
            } else if (iframe.mozRequestFullScreen) {
              iframe.mozRequestFullScreen();
            } else if (iframe.msRequestFullscreen) {
              iframe.msRequestFullscreen();
            }
          };
        }, 2000);
      }
      
      console.log('视频URL:', videoUrl);
    });
  </script>
</body>
</html>
